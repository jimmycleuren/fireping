Install os dependencies
-----------------------
sudo apt-get install ca-certificates apt-transport-https

wget -q https://packages.sury.org/php/apt.gpg -O- | sudo apt-key add -
echo "deb https://packages.sury.org/php/ stretch main" | sudo tee /etc/apt/sources.list.d/php.list

sudo apt-get update

sudo apt-get install fping php-cli php-xml php-mbstring php-zip php-curl php-rrd git supervisor

Install composer
----------------
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (hash_file('SHA384', 'composer-setup.php') === '544e09ee996cdf60ece3804abc52599c22b1f40f4323403c44d44fdfdd586475ca9813a858088ffbc1f233e9b180f061') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
php composer-setup.php
php -r "unlink('composer-setup.php');"
sudo mv composer.phar /usr/local/bin/composer

Install fireping
----------------
cd /opt
git clone https://github.com/jimmycleuren/fireping.git

cd fireping
composer install

Slave configuration
-------------------

The following environment variables are needed when running a slave. You can specify these in a .env file.

- SLAVE_NAME=<give a name to this slave>
- SLAVE_URL=<the base url for the fireping master>

Supervisor
--------------------

Supervisor will be the process manager used to start your slave and to keep it running.

- `/etc/supervisor/supervisord.conf` is the main configuration file used for supervisor.
- make sure that the [include] directive is configured to include the `.conf` files from the `conf.d/` directory:
```
[include]
files = /etc/supervisor/conf.d/*.conf
```
- copy the `fireping-slave.conf` file from `/opt/fireping/app/config/supervisord/fireping-slave.conf` to `/etc/supervisor/conf.d/`
- `supervisorctl` to start the supervisor front-end interface
- `reread` in supervisorctl to reread the configuration file (will not restart any existing processes)
```
supervisor> reread
fireping-slave: available
```
- `add fireping-slave` to add it to the manager
```
supervisor> add fireping-slave
fireping-slave: added process group
```
- your slave will now start.

Logrotate
---------

Slaves will generate a significant amount of logging. In order to mitigate disk usage somewhat, do the following:
```
(sudo) cp /opt/fireping/app/config/logrotate/fireping-slave /etc/logrotate.d/
```
Then edit the file and adjust the path if necessary
```
(sudo) vi /etc/logrotate.d/fireping-slave
```
Then, if you're doing this retroactively, you can force the logrotate to run now:
```
(sudo) logrotate --force /etc/logrotate.d/fireping-slave
```

Extra steps master
------------------
sudo apt-get install mariadb-server php-mysql nginx php-fpm redis-server acl php-rrd
sudo mysql
create database fireping;
CREATE USER 'fireping'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON fireping . * TO 'fireping'@'localhost';
FLUSH PRIVILEGES;

php bin/console doctrine:migrations:migrate

# Remember to update the parameters.yml file to reflect any changes to database usernames or passwords.
# Also set your hosts file to 192.168.230.11 fireping.test on Windows for any master deployments.


Docker slave
-------------
sudo docker run -d \
-e SLAVE_NAME='myslave' \
-e SLAVE_PASSWORD='mypassword' \
-e SLAVE_URL='https://my.master.com' \
-v /tmp/logs:/app/var/logs \
--restart=unless-stopped \
--name fireping \
jimmycleuren/fireping
